<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–û–°–ë–ë –î–∞–Ω–∏–ª–∏ –ì–∞–ª–∏—Ü—å–∫–æ–≥–æ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(180deg, #b0e0ff 0%, #e0f7fa 100%);
            color: #1e293b;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.05);
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .btn-primary {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 2px 10px rgba(79, 172, 254, 0.3);
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:active { transform: scale(0.98); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>

<body x-data="osbbApp()" class="flex flex-col items-center p-4 h-full w-full">

    <header class="w-full max-w-sm text-center mb-4 shrink-0 z-50 relative">
        <h1 class="text-xl font-bold text-slate-800 uppercase tracking-wide">–ö–∞—Ä—Ç–∫–∞ –º–µ—à–∫–∞–Ω—Ü—è</h1>
        <p class="text-xs text-slate-600 font-medium">–û–°–ë–ë ¬´–î–∞–Ω–∏–ª–∏ –ì–∞–ª–∏—Ü—å–∫–æ–≥–æ¬ª</p>
        
        <template x-if="page !== 'login'">
            <div class="mt-2 inline-block bg-white/50 px-3 py-0.5 rounded-full text-[10px] font-bold text-slate-700 shadow-sm">
                –ö–≤–∞—Ä—Ç–∏—Ä–∞ ‚Ññ <span x-text="user.flat"></span>
            </div>
        </template>
    </header>

    <!-- –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
    <div x-show="loading" class="fixed inset-0 bg-black/20 z-[60] flex items-center justify-center backdrop-blur-sm" style="display: none;">
        <div class="w-12 h-12 border-4 border-white border-t-blue-500 rounded-full animate-spin"></div>
    </div>

    <main class="w-full max-w-sm flex-grow relative grid grid-cols-1 grid-rows-1 overflow-hidden">

        <!-- ========== –ï–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–Ü–á ========== -->
        <div x-show="page === 'login'" x-transition.opacity.duration.300ms class="col-start-1 row-start-1 w-full flex flex-col justify-center z-20">
            <div class="glass-card rounded-2xl p-6 text-center w-full shadow-lg">
                <h2 class="text-lg font-semibold mb-4 text-slate-700">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</h2>
                
                <div class="space-y-3">
                    <div class="text-left">
                        <input type="number" x-model="input.flat" placeholder="‚Ññ –ö–≤–∞—Ä—Ç–∏—Ä–∏" 
                               class="w-full bg-white/80 border-0 rounded-xl p-3 text-center font-semibold text-slate-800 shadow-inner focus:ring-2 focus:ring-blue-400 focus:outline-none placeholder-slate-400">
                    </div>
                    
                    <div class="text-left">
                        <input type="password" x-model="input.password" placeholder="–ü–∞—Ä–æ–ª—å" 
                               class="w-full bg-white/80 border-0 rounded-xl p-3 text-center font-semibold text-slate-800 shadow-inner focus:ring-2 focus:ring-blue-400 focus:outline-none placeholder-slate-400">
                    </div>

                    <button @click="login" class="btn-primary w-full py-3 rounded-xl text-white font-bold text-md uppercase tracking-wider mt-2 shadow-lg">
                        –í—Ö—ñ–¥
                    </button>
                    
                    <p x-show="errorMsg" x-text="errorMsg" class="text-red-500 text-xs font-medium mt-1" style="display: none;"></p>
                </div>
            </div>
        </div>

        <!-- ========== –ì–û–õ–û–í–ù–ò–ô –ï–ö–†–ê–ù (DASHBOARD) ========== -->
        <div x-show="page === 'dashboard'" x-transition.opacity.duration.300ms class="col-start-1 row-start-1 w-full flex flex-col h-full overflow-y-auto no-scrollbar pb-20 z-10" style="display: none;">
            
            <!-- –ö–∞—Ä—Ç–∫–∞ –ø–æ–¥–∞–Ω–Ω—è –ø–æ–∫–∞–∑–Ω–∏–∫–∞ –≤–æ–¥–∏ -->
            <div class="glass-card rounded-2xl p-3 mb-3 flex flex-col gap-2 shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 text-xl shadow-sm">
                        <i class="ph-fill ph-drop"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-600">–ü–æ–∫–∞–∑–Ω–∏–∫ –≤–æ–¥–∏</p>
                        <p class="text-[10px] text-slate-400">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π: <span x-text="user.lastCounter" class="font-bold text-slate-700"></span></p>
                    </div>
                </div>
                <input type="number" x-model="input.counter" placeholder="–ü–æ—Ç–æ—á–Ω–∏–π –ø–æ–∫–∞–∑–Ω–∏–∫" 
                       class="w-full bg-white/90 border-0 rounded-xl p-2.5 text-center font-semibold text-slate-800 shadow-sm focus:ring-2 focus:ring-blue-400 focus:outline-none placeholder-slate-400 text-sm">
                <button @click="submitCounter" class="btn-primary w-full py-2 rounded-xl text-white font-bold text-xs uppercase tracking-wider">
                    –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏
                </button>
            </div>

            <!-- –ö–∞—Ä—Ç–∫–∞ —Å–ø–ª–∞—Ç–∏ –û–°–ë–ë -->
            <div class="glass-card rounded-2xl p-3 mb-3 flex flex-col gap-2 shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center text-green-600 text-xl shadow-sm">
                        <i class="ph-fill ph-currency-circle-dollar"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-600">–°–ø–ª–∞—Ç–∞ –∑–∞ –û–°–ë–ë</p>
                    </div>
                </div>
                <input type="number" x-model="input.osbbAmount" placeholder="–°—É–º–∞ (–≥—Ä–Ω)" 
                       class="w-full bg-white/90 border-0 rounded-xl p-2.5 text-center font-semibold text-slate-800 shadow-sm focus:ring-2 focus:ring-blue-400 focus:outline-none placeholder-slate-400 text-sm">
                <button @click="submitOsbbPayment" class="btn-primary w-full py-2 rounded-xl text-white font-bold text-xs uppercase tracking-wider shadow-lg">
                    –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏
                </button>
            </div>

            <!-- –ö–∞—Ä—Ç–∫–∞ —Å–ø–ª–∞—Ç–∏ –≤–æ–¥–∏ -->
            <div class="glass-card rounded-2xl p-3 mb-3 flex flex-col gap-2 shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-cyan-100 rounded-xl flex items-center justify-center text-cyan-600 text-xl shadow-sm">
                        <i class="ph-fill ph-currency-circle-dollar"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-600">–°–ø–ª–∞—Ç–∞ –∑–∞ –≤–æ–¥—É</p>
                    </div>
                </div>
                <input type="number" x-model="input.waterAmount" placeholder="–°—É–º–∞ (–≥—Ä–Ω)" 
                       class="w-full bg-white/90 border-0 rounded-xl p-2.5 text-center font-semibold text-slate-800 shadow-sm focus:ring-2 focus:ring-blue-400 focus:outline-none placeholder-slate-400 text-sm">
                <button @click="submitWaterPayment" class="btn-primary w-full py-2 rounded-xl text-white font-bold text-xs uppercase tracking-wider shadow-lg">
                    –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏
                </button>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –¥–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
            <button @click="page = 'stats'" class="glass-card rounded-2xl p-3 flex items-center justify-between hover:bg-white/40 transition-colors">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center text-purple-600 text-xl shadow-sm">
                        <i class="ph-fill ph-chart-bar"></i>
                    </div>
                    <p class="text-sm font-semibold text-slate-700">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞ –±–æ—Ä–≥–∏</p>
                </div>
                <i class="ph ph-caret-right text-slate-400"></i>
            </button>
        </div>

        <!-- ========== –ï–ö–†–ê–ù –°–¢–ê–¢–ò–°–¢–ò–ö–ò ========== -->
        <div x-show="page === 'stats'" x-transition.opacity.duration.300ms class="col-start-1 row-start-1 w-full flex flex-col h-full overflow-y-auto no-scrollbar pb-20 z-10" style="display: none;">
            
            <div class="mb-3 flex items-center justify-between gap-2">
                <button @click="page = 'dashboard'" class="glass-card rounded-xl p-2 flex items-center gap-2 text-slate-600 hover:bg-white/40 transition-colors">
                    <i class="ph ph-caret-left"></i>
                    <span class="text-sm font-medium">–ù–∞–∑–∞–¥</span>
                </button>
                
                <button @click="loadUserData" class="glass-card rounded-xl p-2 flex items-center gap-2 text-blue-600 hover:bg-white/40 transition-colors">
                    <i class="ph ph-arrow-clockwise text-lg"></i>
                    <span class="text-sm font-medium">–û–Ω–æ–≤–∏—Ç–∏</span>
                </button>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ä–≥—ñ–≤ -->
            <div class="glass-card rounded-2xl p-4 mb-3">
                <h3 class="text-md font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <i class="ph-fill ph-chart-pie text-purple-600"></i>
                    –§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å
                </h3>
                
                <div class="space-y-2">
                    <!-- –û–°–ë–ë -->
                    <div class="bg-white/50 rounded-xl p-3">
                        <p class="text-xs text-slate-500 mb-1">–û–°–ë–ë</p>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] text-slate-600">–ü–µ—Ä–µ–ø–ª–∞—Ç–∞:</span>
                            <span class="text-sm font-bold" 
                                  :class="user.osbbOverpayment === '‚Äî' ? 'text-slate-600' : 'text-slate-400'"
                                  x-text="user.osbbOverpayment === '‚Äî' ? '‚Äî' : user.osbbOverpayment + ' –≥—Ä–Ω'"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] text-slate-600">–ë–æ—Ä–≥:</span>
                            <span class="text-sm font-bold" 
                                  :class="user.osbbDebt === '‚Äî' ? 'text-slate-600' : 'text-red-600'"
                                  x-text="user.osbbDebt === '‚Äî' ? '‚Äî' : user.osbbDebt + ' –≥—Ä–Ω'"></span>
                        </div>
                    </div>

                    <!-- –í–æ–¥–∞ -->
                    <div class="bg-white/50 rounded-xl p-3">
                        <p class="text-xs text-slate-500 mb-1">–í–æ–¥–∞</p>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] text-slate-600">–ü–µ—Ä–µ–ø–ª–∞—Ç–∞:</span>
                            <span class="text-sm font-bold" 
                                  :class="user.waterOverpayment === '‚Äî' ? 'text-slate-600' : 'text-green-400'" 
                                  x-text="user.waterOverpayment === '‚Äî' ? '‚Äî' : user.waterOverpayment + ' –≥—Ä–Ω'"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] text-slate-600">–ë–æ—Ä–≥:</span>
                            <span class="text-sm font-bold" 
                                  :class="user.waterDebt === '‚Äî' ? 'text-slate-600' : 'text-red-600'"
                                  x-text="user.waterDebt === '‚Äî' ? '‚Äî' : user.waterDebt + ' –≥—Ä–Ω'"></span>
                        </div>
                    </div>
                </div>
           </div>

            <!-- –ë—é–¥–∂–µ—Ç –±—É–¥–∏–Ω–∫—É -->
            <div class="glass-card rounded-2xl p-4 mb-3">
                <h3 class="text-md font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <i class="ph-fill ph-wallet text-green-600"></i>
                    –ë—é–¥–∂–µ—Ç —Ç–∞ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏
                </h3>
                
                <div class="space-y-3">
                    <!-- –ë—é–¥–∂–µ—Ç -->
                    <div class="bg-white/50 rounded-xl p-3">
                        <p class="text-xs text-slate-500 mb-1">üíµ –ë—é–¥–∂–µ—Ç –±—É–¥–∏–Ω–∫—É —Å–∫–ª–∞–¥–∞—î:</p>
                        <p class="text-lg font-bold text-green-600">52,483 –≥—Ä–Ω</p>
                    </div>

                    <!-- –†–µ–∫–≤—ñ–∑–∏—Ç–∏ -->
                    <div class="bg-white/50 rounded-xl p-3">
                        <p class="text-xs text-slate-500 mb-2">–†–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è —Å–ø–ª–∞—Ç–∏:</p>
                        <div class="space-y-1">
                            <div class="flex items-center justify-between bg-white rounded-lg p-2">
                                <span class="text-sm font-mono font-bold text-slate-800">4441 1110 5218 2718</span>
                                <button onclick="navigator.clipboard.writeText('4441111052182718')" class="text-blue-600 hover:text-blue-700">
                                    <i class="ph ph-copy text-lg"></i>
                                </button>
                            </div>
                            <div class="text-center text-xs text-slate-500">–∞–±–æ</div>
                            <a href="https://send.monobank.ua/3PopUQvnkm" target="_blank" class="block bg-black text-white rounded-lg p-2 text-center text-sm font-semibold hover:bg-gray-800 transition-colors">
                                üí≥ Monobank
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –û—Å—Ç–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
            <div class="glass-card rounded-2xl p-4">
                <h3 class="text-md font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <i class="ph-fill ph-info text-blue-600"></i>
                    –û—Å—Ç–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
                    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É -->
                    <button @click="sendMessageToAdmin" class="glass-card rounded-2xl p-3 flex items-center justify-center gap-2 text-blue-600 hover:bg-white/40 transition-colors font-semibold">
                        <i class="ph-fill ph-chat-text text-xl"></i>
                        <span>–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</span>
                    </button>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-slate-600">–í–∞—Ä—Ç—ñ—Å—Ç—å –æ—Å—Ç–∞–Ω–Ω—å–æ—ó —Ä—ñ–∑–Ω–∏—Ü—ñ:</span>
                        <span class="text-sm font-bold text-slate-800" x-text="user.lastDifferenceCost || '‚Äî'"></span>
                    </div>
                </h3>
                
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-slate-600">–û—Å—Ç–∞–Ω–Ω—ñ–π –ø–æ–∫–∞–∑–Ω–∏–∫:</span>
                        <span class="text-sm font-bold text-slate-800" x-text="user.lastCounter"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-slate-600">–û—Å—Ç–∞–Ω–Ω—ñ–π –ø–ª–∞—Ç—ñ–∂:</span>
                        <span class="text-sm font-bold text-slate-800" x-text="user.lastPaymentDate"></span>
                    </div>
                </div>
            </div>
        </div>

   </main>

    <!-- –§—É—Ç–µ—Ä –∑ –∫–Ω–æ–ø–∫–æ—é "–í–∏—Ö—ñ–¥" (–ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –≤—Å—ñ—Ö –µ–∫—Ä–∞–Ω–∞—Ö –∫—Ä—ñ–º login) -->
    <footer x-show="page !== 'login'"
        <button @click="logout" class="w-full glass-card rounded-2xl p-3 flex items-center justify-center gap-2 text-red-600 hover:bg-red-50 transition-colors font-semibold">
            <i class="ph-fill ph-sign-out text-xl"></i>
            <span>–í–∏—Ö—ñ–¥</span>
        </button>
    </footer>

    <script>
        function osbbApp() {
            return {
                // ========== –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø ==========
                GOOGLE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxSxpyPHuJBClfGeCD4AbBrDG9ZBEIuvFBod_IQWjwccgwvLe8-GOn4G-fEXRa_R7uz/exec', // –ó–ê–ú–Ü–ù–Ü–¢–¨ –ù–ê –°–í–Ü–ô URL

                // ========== –°–¢–ê–ù ==========
                page: 'login',
                loading: false,
                errorMsg: '',
                
                // ========== –î–ê–ù–Ü –ö–û–†–ò–°–¢–£–í–ê–ß–ê ==========
                user: {
                    flat: null,
                    waterOverpayment: '0.00',
                    waterDebt: '0.00',
                    osbbOverpayment: '0.00',
                    osbbDebt: '0.00',
                    lastCounter: '‚Äî',
                    lastPaymentDate: '‚Äî'
                },

                // ========== –ü–û–õ–Ø –í–í–û–î–£ ==========
                input: {
                    flat: '',
                    password: '',
                    counter: '',
                    osbbAmount: '',
                    waterAmount: ''
                },

                // ========== TELEGRAM WEB APP ==========
                tg: window.Telegram?.WebApp || null,
                telegramId: null,

                // ========== –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ==========
                init() {
                    if (this.tg) {
                        this.tg.ready();
                        this.tg.expand();
                        
                        // –û—Ç—Ä–∏–º—É—î–º–æ Telegram ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                        if (this.tg.initDataUnsafe?.user?.id) {
                            this.telegramId = this.tg.initDataUnsafe.user.id;
                        }
                    }

                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –¥–∞–Ω—ñ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
                    this.checkSavedAuth();

                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥ (—è–∫—â–æ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
                    setInterval(() => {
                        if (this.page === 'stats' && this.user.flat) {
                            this.loadUserData();
                        }
                    }, 30000); // 30 —Å–µ–∫—É–Ω–¥
                },

                // ========== –ü–ï–†–ï–í–Ü–†–ö–ê –ó–ë–ï–†–ï–ñ–ï–ù–û–á –ê–í–¢–û–†–ò–ó–ê–¶–Ü–á ==========
                checkSavedAuth() {
                    try {
                        const savedFlat = localStorage.getItem('osbb_flat');
                        const savedPassword = localStorage.getItem('osbb_password');
                        
                        if (savedFlat && savedPassword) {
                            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Ö–æ–¥–∏–º–æ
                            this.input.flat = savedFlat;
                            this.input.password = savedPassword;
                            this.login();
                        }
                    } catch (error) {
                        console.error('Error checking saved auth:', error);
                    }
                },

                // ========== –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø ==========
                async login() {
                    if (!this.input.flat || !this.input.password) {
                        this.errorMsg = '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è';
                        return;
                    }

                    this.loading = true;
                    this.errorMsg = '';

                    try {
                        const params = new URLSearchParams({
                            action: 'auth',
                            flat: this.input.flat,
                            password: this.input.password,
                            telegram_id: this.telegramId || ''
                        });

                        const response = await fetch(`${this.GOOGLE_SCRIPT_URL}?${params}`);
                        const data = await response.json();

                        if (data.success) {
                            this.user.flat = data.flat;
                            
                            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞–Ω—ñ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –≤ localStorage
                            try {
                                localStorage.setItem('osbb_flat', this.input.flat);
                                localStorage.setItem('osbb_password', this.input.password);
                            } catch (e) {
                                console.error('Error saving to localStorage:', e);
                            }
                            
                            this.page = 'dashboard';
                            await this.loadUserData();
                        } else {
                            this.errorMsg = data.error || '–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó';
                        }
                    } catch (error) {
                        console.error('Login error:', error);
                        this.errorMsg = '–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è';
                    } finally {
                        this.loading = false;
                    }
                },

               // ========== –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –î–ê–ù–ò–• –ö–û–†–ò–°–¢–£–í–ê–ß–ê ==========
                async loadUserData() {
                    if (!this.user.flat) return;
                    
                    this.loading = true; // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è

                    try {
                        const params = new URLSearchParams({
                            action: 'getUserData',
                            flat: this.user.flat
                        });

                        const response = await fetch(`${this.GOOGLE_SCRIPT_URL}?${params}`);
                        const data = await response.json();

                        if (data.success) {
                            this.user = { ...this.user, ...data.data };
                        }
                    } catch (error) {
                        console.error('Load user data error:', error);
                    }
                        } catch (error) {
                          console.error('Load user data error:', error);
                        } finally {
                          this.loading = false; // –•–æ–≤–∞—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                        }
                    }
                },

                // ========== –ü–û–î–ê–ù–ù–Ø –ü–û–ö–ê–ó–ù–ò–ö–ê –õ–Ü–ß–ò–õ–¨–ù–ò–ö–ê ==========
                async submitCounter() {
                    if (!this.input.counter || parseFloat(this.input.counter) <= 0) {
                        this.showNotification('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –ø–æ–∫–∞–∑–Ω–∏–∫', 'error');
                        return;
                    }

                    this.loading = true;

                    try {
                        const params = new URLSearchParams({
                            action: 'submitCounter',
                            flat: this.user.flat,
                            counter: this.input.counter
                        });

                        const response = await fetch(`${this.GOOGLE_SCRIPT_URL}?${params}`);
                        const data = await response.json();

                        if (data.success) {
                            this.showNotification('–ü–æ–∫–∞–∑–Ω–∏–∫ —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ! ‚úÖ', 'success');
                            this.input.counter = '';
                            // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–≤–∫–ª—é—á–Ω–æ –∑ –æ—Å—Ç–∞–Ω–Ω—ñ–º –ø–æ–∫–∞–∑–Ω–∏–∫–æ–º)
                            await this.loadUserData();
                        } else {
                            this.showNotification(data.error || '–ü–æ–º–∏–ª–∫–∞', 'error');
                        }
                    } catch (error) {
                        console.error('Submit counter error:', error);
                        this.showNotification('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                // ========== –ü–û–î–ê–ù–ù–Ø –°–ü–õ–ê–¢–ò –û–°–ë–ë ==========
                async submitOsbbPayment() {
                    if (!this.input.osbbAmount || parseFloat(this.input.osbbAmount) <= 0) {
                        this.showNotification('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É', 'error');
                        return;
                    }

                    this.loading = true;

                    try {
                        const params = new URLSearchParams({
                            action: 'submitPayment',
                            flat: this.user.flat,
                            type: 'osbb',
                            amount: this.input.osbbAmount
                        });

                        const response = await fetch(`${this.GOOGLE_SCRIPT_URL}?${params}`);
                        const data = await response.json();

                        if (data.success) {
                            this.showNotification('–ü–ª–∞—Ç—ñ–∂ –∑–∞ –û–°–ë–ë –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ. –ü—ñ—Å–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±—É–¥–µ –≤–Ω–µ—Å–µ–Ω–æ –¥–æ –≤–∞—à–æ–≥–æ —Ä–∞—Ö—É–Ω–∫—É.', 'success');
                            this.input.osbbAmount = '';
                            await this.loadUserData();
                        } else {
                            this.showNotification(data.error || '–ü–æ–º–∏–ª–∫–∞', 'error');
                        }
                    } catch (error) {
                        console.error('Submit OSBB payment error:', error);
                        this.showNotification('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                // ========== –ü–û–î–ê–ù–ù–Ø –°–ü–õ–ê–¢–ò –í–û–î–ò ==========
                async submitWaterPayment() {
                    if (!this.input.waterAmount || parseFloat(this.input.waterAmount) <= 0) {
                        this.showNotification('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É', 'error');
                        return;
                    }

                    this.loading = true;

                    try {
                        const params = new URLSearchParams({
                            action: 'submitPayment',
                            flat: this.user.flat,
                            type: 'water',
                            amount: this.input.waterAmount
                        });

                        const response = await fetch(`${this.GOOGLE_SCRIPT_URL}?${params}`);
                        const data = await response.json();

                        if (data.success) {
                            this.showNotification('–ü–ª–∞—Ç—ñ–∂ –∑–∞ –≤–æ–¥—É –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ. –ü—ñ—Å–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±—É–¥–µ –≤–Ω–µ—Å–µ–Ω–æ –¥–æ –≤–∞—à–æ–≥–æ —Ä–∞—Ö—É–Ω–∫—É.', 'success');
                            this.input.waterAmount = '';
                            await this.loadUserData();
                        } else {
                            this.showNotification(data.error || '–ü–æ–º–∏–ª–∫–∞', 'error');
                        }
                    } catch (error) {
                        console.error('Submit water payment error:', error);
                        this.showNotification('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
// ========== –í–Ü–î–ü–†–ê–í–ö–ê –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø –ê–î–ú–Ü–ù–Ü–°–¢–†–ê–¢–û–†–£ ==========
async sendMessageToAdmin() {
    const message = prompt("–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
    if (!message || message.trim() === '') return;
    
    this.loading = true;
    
    try {
        const params = new URLSearchParams({
            action: 'sendAdminMessage',
            flat: this.user.flat,
            message: message
        });

        const response = await fetch(`${this.GOOGLE_SCRIPT_URL}?${params}`);
        const data = await response.json();

        if (data.success) {
            this.showNotification('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É! ‚úÖ', 'success');
        } else {
            this.showNotification(data.error || '–ü–æ–º–∏–ª–∫–∞', 'error');
        }
    } catch (error) {
        console.error('Send admin message error:', error);
        this.showNotification('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è', 'error');
    } finally {
        this.loading = false;
    }
},
                // ========== –ü–û–ö–ê–ó –°–ü–û–í–Ü–©–ï–ù–ù–Ø ==========
                showNotification(message, type = 'info') {
                    if (this.tg) {
                        this.tg.showAlert(message);
                    } else {
                        alert(message);
                    }
                },

                // ========== –í–ò–•–Ü–î ==========
                logout() {
                    // –û—á–∏—â–∞—î–º–æ localStorage
                    try {
                        localStorage.removeItem('osbb_flat');
                        localStorage.removeItem('osbb_password');
                    } catch (e) {
                        console.error('Error clearing localStorage:', e);
                    }

                    this.page = 'login';
                    this.user = {
                        flat: null,
                        waterOverpayment: '‚Äî',
                        waterDebt: '‚Äî',
                        osbbOverpayment: '‚Äî',
                        osbbDebt: '‚Äî',
                        lastCounter: '‚Äî',
                        lastPaymentDate: '‚Äî'
                    };
                    this.input = {
                        flat: '',
                        password: '',
                        counter: '',
                        osbbAmount: '',
                        waterAmount: ''
                    };
                    this.errorMsg = '';
                }
            }
        }
    </script>

</body>
</html>
